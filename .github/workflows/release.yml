name: Build and Release
on:
  push:
  workflow_dispatch:

jobs:
  check:
    runs-on: ubuntu-latest
    outputs:
      skip: ${{ steps.check_commit_msg.outputs.skip }}
    steps:
      - name: Check commit message
        id: check_commit_msg
        run: |
          if [[ "${{ github.event.head_commit.message }}" == rel* || "${{ github.event_name }}" == 'workflow_dispatch' ]]; then
            echo "skip=false" >> $GITHUB_OUTPUT
          else
            echo "Commit message does not start with 'rel', skipping build."
            echo "skip=true" >> $GITHUB_OUTPUT
          fi

  build:
    needs: check
    if: needs.check.outputs.skip == 'false'
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        id: cp313
        with:
          python-version: '3.13'

      - name: Install dependencies
        run: |
          pip install --disable-pip-version-check --no-cache-dir -r requirements.txt

      - name: Package code and Python environment
        run: |
          # 清理并重新创建package目录
          if (Test-Path package) {
            Remove-Item package -Recurse -Force
          }
          mkdir package
          
          # 复制代码文件，排除package目录
          Get-ChildItem -Path . -Exclude package -Recurse | ForEach-Object {
            try {
              if ($_.PSIsContainer) {
                Copy-Item -Recurse -Path $_.FullName -Destination package -ErrorAction Stop
              } else {
                Copy-Item -Path $_.FullName -Destination package -ErrorAction Stop
              }
            } catch {
              Write-Warning "无法复制 $($_.FullName): $_"
            }
          }
          
          # 复制Python环境
          ${{ steps.cp313.outputs.python-path }} > python_path.txt
          $PYTHON_PATH = Get-Content python_path.txt
          if (!(Test-Path "package\python_env")) {
            mkdir "package\python_env"
          }
          xcopy "$PYTHON_PATH\.." "package\python_env\" /E /H /C /I /Y
          
          # 创建启动脚本
          @"
          @echo off
          python_env\python.exe main.py
          pause
          "@ | Out-File -FilePath "package\start.cmd" -Encoding ascii

      - name: Upload package artifact
        uses: actions/upload-artifact@v4
        with:
          name: packaged-code
          path: package/

      - name: Clean up
        run: |
          rm package/  -Recurse -Force
          echo "Cleaned up build artifacts."

  release:
    needs: [check, build]
    if: needs.check.outputs.skip == 'false'
    runs-on: windows-latest
    steps:
      - name: Download package artifact
        uses: actions/download-artifact@v4
        with:
          name: packaged-code
          path: package/

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: package/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}